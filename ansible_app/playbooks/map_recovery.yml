---
- include: proxy.yml

- hosts: map_docker
  gather_facts: false
  tasks:
    - name: Check MAP container status
      command:
      register: map_container_result
      ignore_error: True

    - name: Restart map container
      command: chdir=/home/core/tacstack ~/bin/docker-compose -f docker-compose-testenv.yml -p han restart 
      #command: cd /home/core/tacstack && ~/bin/docker-compose -f docker-compose-prod.yml restart
      changed_when: False
      # TBC
      when: map_container_result.stderr
      
      register: restart_result
      failed_when: "restart_result.stderr.count('Restarting han') <= 2"
      #failed_when: "restart_result.stderr.count('Restarting tacstack') < 2"


    #- debug: var=restart_result

    # - name: Cleanup MAP by running MAPJanitor
    #   command: docker exec tacstack_mapappprod_1 python /home/bdt/map/src/map_backend_server/MAPJanitor.py
    #   register: janitor_result
    #   changed_when: false
    #   failed_when: "'Cleanup Done!' not in janitor_result.stdout"

    # - name: Start MAP related services
